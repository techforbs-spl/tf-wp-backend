name: Deploy WP Backend to Hostinger

on:
  workflow_dispatch:
    inputs:
      plugin_path:
        description: 'Path in repo to deploy (relative). Use "." for repo root.'
        required: false
        default: '.'
  push:
    branches:
      - main
    paths:
      - 'techforbs-components/**'

jobs:
  deploy:
    name: Deploy (FTP)
    runs-on: ubuntu-latest
    env:
      FTP_HOST: "${{ secrets.HOSTINGER_FTP_HOST }}"
      FTP_USER: "${{ secrets.HOSTINGER_FTP_USER }}"
      FTP_PASS: "${{ secrets.HOSTINGER_FTP_PASSWORD }}"
      FTP_PORT: "${{ secrets.HOSTINGER_FTP_PORT }}"
      FTP_TARGET_DIR: "${{ secrets.HOSTINGER_FTP_TARGET_DIR }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set defaults (compute PLUGIN_PATH)
        run: |
          PLUGIN_PATH="${{ github.event.inputs.plugin_path }}"
          if [ -z "$PLUGIN_PATH" ]; then
            PLUGIN_PATH="techforbs-components"
          fi
          echo "PLUGIN_PATH=$PLUGIN_PATH" >> $GITHUB_ENV

      - name: Show repo files (sanity)
        run: ls -la

      - name: "Debug: print workspace and plugin path"
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "PWD: $(pwd)"
          echo "PLUGIN_PATH (env): $PLUGIN_PATH"
          if [ -z "$PLUGIN_PATH" ]; then
            echo "PLUGIN_PATH is empty"
          else
            if command -v realpath >/dev/null 2>&1; then
              echo "Resolved PLUGIN_PATH:" $(realpath "$PLUGIN_PATH")
            elif command -v readlink >/dev/null 2>&1; then
              echo "Resolved PLUGIN_PATH:" $(readlink -f "$PLUGIN_PATH")
            else
              echo "realpath/readlink not available to resolve PLUGIN_PATH"
            fi
            echo "Listing PLUGIN_PATH contents (if exists):"
            ls -la "$PLUGIN_PATH" || echo "PLUGIN_PATH does not exist"
          fi

      - name: Create archive
        run: |
          PLUGIN_DIR="$PLUGIN_PATH"
          # Allow archiving repo root (.) or a subdirectory.
          if [ "$PLUGIN_DIR" = "." ] || [ "$PLUGIN_DIR" = "./" ]; then
            echo "Archiving repository root to plugin-deploy.zip (excluding .git)"
            zip -r plugin-deploy.zip . -x ".git/*" -x "plugin-deploy.zip"
          else
            if [ ! -e "$PLUGIN_DIR" ]; then
              echo "Directory or path $PLUGIN_DIR not found, listing root and failing." && ls -la && exit 1
            fi
            echo "Archiving $PLUGIN_DIR to plugin-deploy.zip (excluding .git)"
            zip -r plugin-deploy.zip "$PLUGIN_DIR" -x ".git/*" -x "plugin-deploy.zip"
          fi
          ls -lh plugin-deploy.zip

      # SSH backup steps removed — FTP-only deploy

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: "${{ secrets.HOSTINGER_FTP_HOST }}"
          username: "${{ secrets.HOSTINGER_FTP_USER }}"
          password: "${{ secrets.HOSTINGER_FTP_PASSWORD }}"
          port: "${{ secrets.HOSTINGER_FTP_PORT }}"
          local-dir: "${{ env.PLUGIN_PATH }}"
          server-dir: "${{ secrets.HOSTINGER_FTP_TARGET_DIR }}"

      # Post-deploy SSH steps removed — using FTP only

      - name: Done
        run: echo "Deployment job finished."

# last-checked: 2025-12-20T00:00:00Z
