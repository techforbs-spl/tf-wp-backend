name: Deploy WP Backend to Hostinger

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'If true, only list remote files (no upload)'
        required: false
        default: 'true'
      plugin_path:
        description: 'Path in repo to deploy (relative)'
        required: false
        default: 'techforbs-components'
  push:
    branches:
      - main
    paths:
      - 'techforbs-components/**'

jobs:
  deploy:
    name: Deploy (FTP)
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
      FTP_USER: ${{ secrets.HOSTINGER_FTP_USER }}
      FTP_PASS: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
      FTP_PORT: ${{ secrets.HOSTINGER_FTP_PORT }}
      FTP_TARGET_DIR: ${{ secrets.HOSTINGER_FTP_TARGET_DIR }}
      SSH_KEY: ${{ secrets.HOSTINGER_SSH_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set defaults
        run: |
          echo "PLUGIN_PATH=${{ github.event.inputs.plugin_path || 'techforbs-components' }}" >> $GITHUB_ENV
          echo "DRY_RUN=${{ github.event.inputs.dry_run || 'true' }}" >> $GITHUB_ENV

      - name: Show repo files (sanity)
        run: ls -la

      - name: Create archive
        run: |
          PLUGIN_DIR="$PLUGIN_PATH"
          if [ ! -d "$PLUGIN_DIR" ]; then
            echo "Directory $PLUGIN_DIR not found, listing root and failing." && ls -la && exit 1
          fi
          zip -r plugin-deploy.zip "$PLUGIN_DIR"
          ls -lh plugin-deploy.zip

      - name: Dry-run: list remote target (only when dry_run=true)
        if: env.DRY_RUN == 'true'
        run: |
          echo "=== DRY RUN ==="
          sudo apt-get update -y && sudo apt-get install -y lftp
          echo "Listing remote target ${FTP_TARGET_DIR} on ${FTP_HOST}:${FTP_PORT} as ${FTP_USER}"
          lftp -u "${FTP_USER}","${FTP_PASS}" -p ${FTP_PORT} ${FTP_HOST} -e "cls -1 ${FTP_TARGET_DIR}; bye"

      - name: Optional remote backup (requires SSH_KEY) - prepare
        if: env.DRY_RUN != 'true' && env.SSH_KEY
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}

      - name: Optional remote backup (requires SSH_KEY) - run
        if: env.DRY_RUN != 'true' && env.SSH_KEY
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          port: ${{ secrets.HOSTINGER_FTP_PORT || '22' }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          script: |
            set -e
            TS=$(date +"%Y%m%d-%H%M%S")
            TARGET="${{ secrets.HOSTINGER_FTP_TARGET_DIR }}"
            if [ -d "$TARGET" ]; then
              echo "Creating backup $TARGET.bak.$TS"
              mv "$TARGET" "$TARGET.bak.$TS" || echo "mv failed or no permission"
            else
              echo "No existing target to backup: $TARGET"
            fi

      - name: Deploy via FTP
        if: env.DRY_RUN != 'true'
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: ${{ secrets.HOSTINGER_FTP_PORT }}
          local-dir: ${{ github.event.inputs.plugin_path || 'techforbs-components' }}
          server-dir: ${{ secrets.HOSTINGER_FTP_TARGET_DIR }}

      - name: Post-deploy: set permissions (SSH) (optional)
        if: env.DRY_RUN != 'true' && env.SSH_KEY
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          port: ${{ secrets.HOSTINGER_FTP_PORT || '22' }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          script: |
            set -e
            TARGET="${{ secrets.HOSTINGER_FTP_TARGET_DIR }}"
            echo "Setting permissions on $TARGET"
            chmod -R 755 "$TARGET" || true

      - name: Done
        run: echo "Deployment job finished."
